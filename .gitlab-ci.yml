stages:
  - test
  - build

tests:
  services:
    - docker:dind

  variables:
    DOCKER_HOST: "tcp://docker:2375"

  image: adoptopenjdk/openjdk11:latest
  stage: test
  script:
    - ./gradlew clean test

build:jar:
  image: adoptopenjdk/openjdk11:latest
  stage: build
  script:
    - ./gradlew clean build -x test
  artifacts:
    paths:
      - build/libs/

build:docker-image:
  services:
    - docker:dind

  variables:
    DOCKER_HOST: "tcp://docker:2375"

  image: docker:latest
  stage: build
  script:
    - ./build.sh
  dependencies:
    - build:jar